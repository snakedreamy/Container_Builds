name: æ„å»ºå¹¶å‘å¸ƒ n8n-runners é•œåƒ

on:
  push:
    branches: [ "main" ]
    paths:
      - "images/n8n-runners/**"
      - ".github/workflows/build-n8n-runners.yml"
  workflow_dispatch:
  schedule:
    - cron: "15 */6 * * *"

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- ä¿®å¤ç‚¹ï¼šä½¿ç”¨ skopeo æ›¿ä»£ docker manifest inspect ---
      - name: è·å–ä¸Šæ¸¸ runners:latest æ‘˜è¦
        id: upstream
        run: |
          set -euo pipefail
          
          UPSTREAM_IMAGE="ghcr.io/n8n-io/runners:latest"
          echo "æ­£åœ¨æ£€æŸ¥ä¸Šæ¸¸: ${UPSTREAM_IMAGE} ..."
          
          # ä½¿ç”¨ skopeo ç›´æ¥è·å– Digestï¼Œæ— éœ€ jq è§£æå¤æ‚çš„ manifest ç»“æ„
          DIGEST=$(skopeo inspect docker://${UPSTREAM_IMAGE} --format '{{.Digest}}')
          
          if [ -z "${DIGEST}" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è·å–ä¸Šæ¸¸é•œåƒ Digest" >&2
            exit 1
          fi

          # æˆªå–å‰12ä½ä½œä¸ºçŸ­æ‘˜è¦
          SHORT_DIGEST=$(echo "${DIGEST}" | sed 's/^sha256://' | cut -c1-12)
          
          echo "upstream_digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "short_digest=${SHORT_DIGEST}" >> "$GITHUB_OUTPUT"
          
          echo "âœ… ä¸Šæ¸¸æœ€æ–° Digest: ${DIGEST}"
          echo "ğŸ”– çŸ­æ‘˜è¦: ${SHORT_DIGEST}"

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
        id: check
        run: |
          # æˆ‘ä»¬çš„ Tag ç­–ç•¥ï¼šdigest-<short_hash>
          MY_IMAGE="ghcr.io/${{ github.repository_owner }}/n8n-runners:digest-${{ steps.upstream.outputs.short_digest }}"
          
          echo "æ­£åœ¨æ£€æŸ¥æœ¬åœ°é•œåƒ: ${MY_IMAGE} ..."

          # æ£€æŸ¥æˆ‘ä»¬è‡ªå·±çš„é•œåƒæ˜¯å¦å­˜åœ¨
          if docker manifest inspect "${MY_IMAGE}" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ‰ é•œåƒå·²å­˜åœ¨ä¸”æœ€æ–°ï¼Œæ— éœ€æ„å»ºã€‚"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "ğŸš€ å‘ç°æ–°ç‰ˆæœ¬ (æˆ–æœ¬åœ°ç¼ºå¤±)ï¼Œå‡†å¤‡æ„å»ºï¼"
          fi

      - uses: docker/setup-qemu-action@v3
        if: steps.check.outputs.exists != 'true'
      - uses: docker/setup-buildx-action@v3
        if: steps.check.outputs.exists != 'true'

      - name: æ„å»ºå¹¶æ¨é€ n8n-runners
        if: steps.check.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: images/n8n-runners
          file: images/n8n-runners/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            RUNNERS_VERSION=latest
          tags: |
            ghcr.io/${{ github.repository_owner }}/n8n-runners:latest
            ghcr.io/${{ github.repository_owner }}/n8n-runners:digest-${{ steps.upstream.outputs.short_digest }}
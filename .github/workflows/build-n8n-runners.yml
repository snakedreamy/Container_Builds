name: æ„å»ºå¹¶å‘å¸ƒ n8n-runners é•œåƒ

on:
  push:
    branches: ["main"]
    paths:
      - "images/n8n-runners/**"
      - ".github/workflows/build-n8n-runners.yml"
  workflow_dispatch:
  schedule:
    - cron: "15 */6 * * *"

permissions:
  contents: read
  packages: write

concurrency:
  group: build-n8n-runners
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–ï¼ˆskopeo/jqï¼‰
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: è·å–ä¸Šæ¸¸ n8n æœ€æ–°ç‰ˆæœ¬å·ï¼ˆç”¨äºåŒ¹é… runners æ ‡ç­¾ï¼‰
        id: upstream_version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          RAW_TAG="$(curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/n8n-io/n8n/releases/latest \
            | jq -r '.tag_name')"

          VERSION="$(echo "${RAW_TAG}" | sed -E 's/^v//; s/^n8n@//')"
          if [ -z "${VERSION}" ] || [ "${VERSION}" = "null" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è§£æä¸Šæ¸¸ç‰ˆæœ¬å·ï¼ˆtag_name=${RAW_TAG}ï¼‰" >&2
            exit 1
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "âœ… æ¢æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: ${VERSION}"

      - name: è·å–ä¸Šæ¸¸ runners é•œåƒ Digestï¼ˆè‹¥æœªåŒæ­¥åˆ™è·³è¿‡ï¼‰
        id: upstream
        run: |
          set -euo pipefail
          VERSION="${{ steps.upstream_version.outputs.version }}"
          UPSTREAM_IMAGE="ghcr.io/n8n-io/runners:${VERSION}"

          echo "æ­£åœ¨æ£€æŸ¥ä¸Šæ¸¸: ${UPSTREAM_IMAGE} ..."

          if DIGEST="$(skopeo inspect "docker://${UPSTREAM_IMAGE}" --format '{{.Digest}}' 2>/dev/null)"; then
            SHORT_DIGEST="$(echo "${DIGEST}" | sed 's/^sha256://' | cut -c1-12)"
            echo "upstream_available=true" >> "$GITHUB_OUTPUT"
            echo "upstream_digest=${DIGEST}" >> "$GITHUB_OUTPUT"
            echo "short_digest=${SHORT_DIGEST}" >> "$GITHUB_OUTPUT"
            echo "âœ… ä¸Šæ¸¸ Digest: ${DIGEST}"
            echo "ğŸ”– çŸ­æ‘˜è¦: ${SHORT_DIGEST}"
          else
            echo "upstream_available=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ ä¸Šæ¸¸ runners GHCR å°šæœªåŒæ­¥ç‰ˆæœ¬ ${VERSION}ï¼Œè·³è¿‡æœ¬æ¬¡æ„å»º"
          fi

      - name: ç™»å½• GHCR
        if: steps.upstream.outputs.upstream_available == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¡ç®—æœ¬åœ°æ„å»ºä¸Šä¸‹æ–‡ Hashï¼ˆimages/n8n-runnersï¼‰
        if: steps.upstream.outputs.upstream_available == 'true'
        id: ctx
        run: |
          set -euo pipefail
          CTX="$( (find images/n8n-runners -type f -print0 | sort -z | xargs -0 sha256sum) \
                | sha256sum | awk '{print $1}' | cut -c1-12 )"
          echo "ctx=${CTX}" >> "$GITHUB_OUTPUT"
          echo "ğŸ“¦ æœ¬åœ°ä¸Šä¸‹æ–‡çŸ­å“ˆå¸Œ: ${CTX}"

      - name: ç”Ÿæˆ Build Key
        if: steps.upstream.outputs.upstream_available == 'true'
        id: key
        run: |
          set -euo pipefail
          UP_SHORT="${{ steps.upstream.outputs.short_digest }}"
          CTX="${{ steps.ctx.outputs.ctx }}"
          BUILD_KEY="${UP_SHORT}-${CTX}"
          echo "build_key=${BUILD_KEY}" >> "$GITHUB_OUTPUT"
          echo "ğŸ”‘ Build Key: ${BUILD_KEY}"

      - name: æ£€æŸ¥ build-<key> æ˜¯å¦å·²å­˜åœ¨
        if: steps.upstream.outputs.upstream_available == 'true'
        id: check
        run: |
          set -euo pipefail
          VERSION="${{ steps.upstream_version.outputs.version }}"
          IMG="ghcr.io/${{ github.repository_owner }}/n8n-runners:build-${{ steps.key.outputs.build_key }}"
          echo "æ­£åœ¨æ£€æŸ¥é•œåƒ: ${IMG}"

          if docker manifest inspect "${IMG}" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ‰ å·²å­˜åœ¨ï¼ˆåŒ upstream + åŒæœ¬åœ°ä¸Šä¸‹æ–‡ï¼‰ï¼Œè·³è¿‡æ„å»º"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "ğŸš€ ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ„å»º"
          fi

      - uses: docker/setup-qemu-action@v3
        if: steps.check.outputs.exists != 'true' && steps.upstream.outputs.upstream_available == 'true'
      - uses: docker/setup-buildx-action@v3
        if: steps.check.outputs.exists != 'true' && steps.upstream.outputs.upstream_available == 'true'

      - name: æ„å»ºå¹¶æ¨é€ n8n-runners
        if: steps.check.outputs.exists != 'true' && steps.upstream.outputs.upstream_available == 'true'
        uses: docker/build-push-action@v6
        with:
          context: images/n8n-runners
          file: images/n8n-runners/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            RUNNERS_VERSION=${{ steps.upstream_version.outputs.version }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/n8n-runners:latest
            ghcr.io/${{ github.repository_owner }}/n8n-runners:${{ steps.upstream_version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/n8n-runners:digest-${{ steps.upstream.outputs.short_digest }}
            ghcr.io/${{ github.repository_owner }}/n8n-runners:build-${{ steps.key.outputs.build_key }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.upstream_version.outputs.version }}
            io.mu8u.upstream.digest=${{ steps.upstream.outputs.upstream_digest }}
            io.mu8u.build.key=${{ steps.key.outputs.build_key }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ç»“æŸï¼ˆä¸Šæ¸¸æœªåŒæ­¥ï¼‰
        if: steps.upstream.outputs.upstream_available != 'true'
        run: |
          echo "æœªæ„å»ºï¼šä¸Šæ¸¸ runners é•œåƒå°šæœªåœ¨ GHCR åŒæ­¥ã€‚"
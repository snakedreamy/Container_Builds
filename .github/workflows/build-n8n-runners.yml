name: æ„å»ºå¹¶å‘å¸ƒ n8n-runners é•œåƒ

on:
  push:
    branches: [ "main" ]
    paths:
      - "images/n8n-runners/**"
      - ".github/workflows/build-n8n-runners.yml"
  workflow_dispatch:
  schedule:
    - cron: "15 */6 * * *"  # æ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. æ ¸å¿ƒé€»è¾‘ï¼šç›´æ¥å‘ GitHub Container Registry è¯¢é—®ä¸Šæ¸¸æ‘˜è¦
      - name: è·å–ä¸Šæ¸¸ ghcr.io/n8n-io/runners:latest æ‘˜è¦
        id: upstream
        run: |
          set -euo pipefail
          
          # å®šä¹‰ä¸Šæ¸¸é•œåƒåœ°å€ (ä»ä½ çš„æˆªå›¾ä¸­ç¡®è®¤çš„åŒ…å)
          UPSTREAM_IMAGE="ghcr.io/n8n-io/runners:latest"
          
          echo "æ­£åœ¨æ£€æŸ¥ä¸Šæ¸¸: ${UPSTREAM_IMAGE} ..."
          
          # ä½¿ç”¨ docker manifest inspect è·å–çœŸå® digest (æ— éœ€ pull)
          # 2>/dev/null å±è”½éé”™è¯¯ä¿¡æ¯ï¼Œç¡®ä¿è¾“å‡ºå¹²å‡€
          DIGEST=$(docker manifest inspect "${UPSTREAM_IMAGE}" -v 2>/dev/null | jq -r '.Descriptor.digest')
          
          if [ -z "${DIGEST}" ] || [ "${DIGEST}" = "null" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è·å–ä¸Šæ¸¸é•œåƒ Digest" >&2
            exit 1
          fi

          SHORT_DIGEST=$(echo "${DIGEST}" | sed 's/^sha256://' | cut -c1-12)
          
          echo "upstream_digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "short_digest=${SHORT_DIGEST}" >> "$GITHUB_OUTPUT"
          
          echo "âœ… ä¸Šæ¸¸æœ€æ–° Digest: ${DIGEST}"
          echo "ğŸ”– çŸ­æ‘˜è¦: ${SHORT_DIGEST}"

      # 2. ç™»å½• GHCR (ä¸ºäº†æ£€æŸ¥æˆ‘ä»¬è‡ªå·±çš„é•œåƒæ˜¯å¦å­˜åœ¨)
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœæˆ‘ä»¬çš„é•œåƒåº“é‡Œå·²ç»æœ‰äº†è¿™ä¸ª digest çš„ tagï¼Œå°±è·³è¿‡
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
        id: check
        run: |
          # æˆ‘ä»¬ç”Ÿæˆçš„é•œåƒ Tag è§„åˆ™ï¼šdigest-<ä¸Šæ¸¸çŸ­hash>
          MY_IMAGE="ghcr.io/${{ github.repository_owner }}/n8n-runners:digest-${{ steps.upstream.outputs.short_digest }}"
          
          echo "æ­£åœ¨æ£€æŸ¥æœ¬åœ°é•œåƒ: ${MY_IMAGE} ..."

          if docker manifest inspect "${MY_IMAGE}" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ‰ é•œåƒå·²å­˜åœ¨ä¸”æœ€æ–°ï¼Œæ— éœ€æ„å»ºã€‚"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "ğŸš€ å‘ç°æ–°ç‰ˆæœ¬ (æˆ–æœ¬åœ°ç¼ºå¤±)ï¼Œå‡†å¤‡æ„å»ºï¼"
          fi

      # 4. ç¯å¢ƒå‡†å¤‡
      - uses: docker/setup-qemu-action@v3
        if: steps.check.outputs.exists != 'true'
      - uses: docker/setup-buildx-action@v3
        if: steps.check.outputs.exists != 'true'

      # 5. æ„å»ºå¹¶æ¨é€
      - name: æ„å»ºå¹¶æ¨é€ n8n-runners
        if: steps.check.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: images/n8n-runners
          file: images/n8n-runners/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          # ç›´æ¥ä½¿ç”¨ latestï¼Œå› ä¸º runners ä¸»è¦æ˜¯ä½œä¸º n8n çš„å­è¿›ç¨‹è¿è¡Œï¼Œç‰ˆæœ¬è€¦åˆåº¦è¾ƒä½
          build-args: |
            RUNNERS_VERSION=latest
          tags: |
            ghcr.io/${{ github.repository_owner }}/n8n-runners:latest
            ghcr.io/${{ github.repository_owner }}/n8n-runners:digest-${{ steps.upstream.outputs.short_digest }}
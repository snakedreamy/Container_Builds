name: æ„å»ºå¹¶å‘å¸ƒ n8n é•œåƒ (å«ä¸­æ–‡å­—ä½“)

on:
  push:
    branches: [ "main" ]
    paths:
      - "images/n8n/**"
      - ".github/workflows/build-n8n.yml"
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: è·å–ä¸Šæ¸¸ n8n æœ€æ–°ç‰ˆæœ¬å·
        id: upstream_version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          RAW_TAG=$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" https://api.github.com/repos/n8n-io/n8n/releases/latest | jq -r '.tag_name')
          VERSION=$(echo "${RAW_TAG}" | sed -E 's/^v//; s/^n8n@//')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "âœ… æ¢æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: ${VERSION}"

      # --- ä¿®å¤ç‚¹ï¼šä½¿ç”¨ skopeo æ£€æŸ¥ä¸Šæ¸¸é•œåƒæ˜¯å¦å­˜åœ¨ ---
      - name: è·å–ä¸Šæ¸¸é•œåƒ Digest
        id: upstream_digest
        run: |
          set -euo pipefail
          VERSION="${{ steps.upstream_version.outputs.version }}"
          UPSTREAM_IMAGE="ghcr.io/n8n-io/n8n:${VERSION}"
          
          echo "æ­£åœ¨æ£€æŸ¥ä¸Šæ¸¸é•œåƒ: ${UPSTREAM_IMAGE}"
          
          # ä½¿ç”¨ skopeo æ£€æŸ¥æ˜¯å¦å­˜åœ¨
          if ! DIGEST=$(skopeo inspect docker://${UPSTREAM_IMAGE} --format '{{.Digest}}' 2>/dev/null); then
             echo "âš ï¸ ä¸Šæ¸¸ GHCR å°šæœªåŒæ­¥ç‰ˆæœ¬ ${VERSION}ï¼Œè·³è¿‡æœ¬æ¬¡æ„å»º"
             echo "exists=true" >> "$GITHUB_OUTPUT" 
             exit 0
          fi
          
          echo "exists=false" >> "$GITHUB_OUTPUT"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "âœ… ä¸Šæ¸¸ Digest: ${DIGEST}"

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬
        id: check
        if: steps.upstream_digest.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.upstream_version.outputs.version }}"
          MY_IMAGE="ghcr.io/${{ github.repository_owner }}/n8n:${VERSION}"
          
          if docker manifest inspect "${MY_IMAGE}" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ‰ ç‰ˆæœ¬ ${VERSION} å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "ğŸš€ å‡†å¤‡æ„å»ºç‰ˆæœ¬ ${VERSION}"
          fi

      - uses: docker/setup-qemu-action@v3
        if: steps.check.outputs.exists == 'false' && steps.upstream_digest.outputs.exists == 'false'
      - uses: docker/setup-buildx-action@v3
        if: steps.check.outputs.exists == 'false' && steps.upstream_digest.outputs.exists == 'false'

      - name: æ„å»ºå¹¶æ¨é€ n8n
        if: steps.check.outputs.exists == 'false' && steps.upstream_digest.outputs.exists == 'false'
        uses: docker/build-push-action@v6
        with:
          context: images/n8n
          file: images/n8n/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            N8N_VERSION=${{ steps.upstream_version.outputs.version }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/n8n:latest
            ghcr.io/${{ github.repository_owner }}/n8n:${{ steps.upstream_version.outputs.version }}